<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
  />
  <title>Missing Letter Cannon Game</title>

  <style>
    :root {
      --bg: #cfefff;
      --panel: rgba(255,255,255,0.92);
      --ink: #16324a;
      --accent: #2b7cff;
      --shadow: 0 10px 25px rgba(0,0,0,0.12);
      --vh: 1vh; /* updated by JS for iPhone Safari */
    }

    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
      overflow: hidden;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    /* Real viewport height fix (especially iPhone Safari) */
    #game {
      position: relative;
      width: 100vw;
      height: calc(var(--vh) * 100);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Fireworks canvas behind everything */
    #fxCanvas {
      position: absolute;
      inset: 0;
      z-index: 1;
      pointer-events: none;
    }

    /* Top bar (safe area aware) */
    #topBar {
      z-index: 5;
      margin: calc(10px + env(safe-area-inset-top)) auto 8px;
      width: min(94vw, 760px);
      background: var(--panel);
      box-shadow: var(--shadow);
      border-radius: 16px;
      padding: 10px 12px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
      border: 1px solid rgba(0,0,0,0.06);
    }

    #badge {
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      background: #eaf3ff;
      border: 1px solid rgba(43,124,255,0.25);
      color: #1f5fe0;
      font-size: 14px;
      white-space: nowrap;
    }

    #score {
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      background: #eafff4;
      border: 1px solid rgba(33,182,111,0.25);
      color: #158a53;
      font-size: 14px;
      white-space: nowrap;
    }

    #hint { font-size: 14px; opacity: 0.9; }

    /* Main word area grows/shrinks */
    #wordArea {
      z-index: 4;
      flex: 1;
      display: grid;
      place-items: center;
      padding: 8px 10px;
      min-height: 0; /* important for iOS flex */
    }

    #wordCard {
      background: var(--panel);
      box-shadow: var(--shadow);
      border-radius: 22px;
      border: 1px solid rgba(0,0,0,0.06);
      padding: 18px 14px;
      text-align: center;
      max-width: min(94vw, 820px);

      /* subtle float (small so it does not clip) */
      animation: floaty 2.2s ease-in-out infinite;
    }

    @keyframes floaty {
      0%   { transform: translate(0px, 0px); }
      50%  { transform: translate(6px, -5px); }
      100% { transform: translate(0px, 0px); }
    }

    #word {
      font-size: clamp(34px, 8.2vw, 72px);
      font-weight: 950;
      letter-spacing: 0.06em;
      line-height: 1.05;
      user-select: none;
      display: inline-flex;
      gap: 0.06em;
      padding: 2px 8px;
      text-transform: uppercase;
    }

    .letter {
      display: inline-block;
      min-width: 0.9em;
    }

    .blank {
      min-width: 0.9em;
      border-bottom: 6px solid rgba(22,50,74,0.35);
      padding-bottom: 2px;
      transform: translateY(-2px);
    }
    .blank.filled { border-bottom-color: transparent; }

    /* Feedback */
    #feedback {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 7;
      pointer-events: none;
      display: none;
      text-align: center;
    }
    #feedback .emoji { font-size: clamp(60px, 15vw, 90px); }
    #feedback .text { margin-top: 4px; font-weight: 950; font-size: 22px; }

    .shake { animation: shake 0.45s ease-in-out 1; }
    @keyframes shake {
      0% { transform: translate(0,0); }
      20% { transform: translate(-6px, 0); }
      40% { transform: translate(6px, 0); }
      60% { transform: translate(-5px, 0); }
      80% { transform: translate(5px, 0); }
      100% { transform: translate(0,0); }
    }

    /* Bottom panel ALWAYS visible, safe-area aware */
    #bottomPanel {
      z-index: 6;
      width: min(96vw, 920px);
      margin: 0 auto;
      background: var(--panel);
      border-radius: 22px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.06);
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      margin-bottom: env(safe-area-inset-bottom);
    }

    /* Choices wrap cleanly */
    #choicesRow {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      padding: 6px 4px 8px;
    }

    .choiceBtn {
      font-size: clamp(18px, 5.2vw, 22px);
      font-weight: 950;
      width: clamp(50px, 14vw, 62px);
      height: clamp(50px, 14vw, 62px);
      border-radius: 16px;
      border: 2px solid rgba(22,50,74,0.18);
      background: #ffffff;
      box-shadow: 0 6px 14px rgba(0,0,0,0.08);
      cursor: pointer;
      user-select: none;
      transition: transform 0.12s ease, border-color 0.12s ease, background 0.12s ease;
    }
    .choiceBtn:active { transform: scale(0.96); }
    .choiceBtn.selected {
      border-color: rgba(43,124,255,0.85);
      background: #eaf3ff;
      transform: translateY(-2px);
    }

    /* Controls row: responsive, no overflow */
    #controlsRow {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 10px;
      align-items: end;
      padding: 4px;
    }

    #skipBtn {
      font-weight: 900;
      border: 2px solid rgba(22,50,74,0.18);
      background: white;
      color: var(--ink);
      border-radius: 16px;
      padding: 12px 12px;
      cursor: pointer;
      user-select: none;
      font-size: 14px;
      white-space: nowrap;
    }
    #skipBtn:active { transform: scale(0.98); }

    #fireBtn {
      font-size: 18px;
      font-weight: 950;
      padding: 14px 16px;
      border-radius: 16px;
      border: none;
      cursor: pointer;
      background: linear-gradient(180deg, #2b7cff, #1f5fe0);
      color: white;
      box-shadow: 0 14px 22px rgba(43,124,255,0.24);
      user-select: none;
      white-space: nowrap;
    }
    #fireBtn:active { transform: scale(0.98); }
    #fireBtn:disabled { opacity: 0.55; cursor: not-allowed; box-shadow: none; }

    /* Cannon scales with screen */
    #cannonWrap {
      position: relative;
      height: clamp(92px, 16vh, 130px);
      display: flex;
      justify-content: center;
      align-items: flex-end;
      min-width: 0;
    }

    #cannon {
      position: relative;
      width: clamp(160px, 52vw, 220px);
      height: clamp(90px, 14vh, 110px);
    }

    #cannonBase {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 78%;
      height: 50%;
      border-radius: 18px;
      background: #2b3f54;
      box-shadow: inset 0 8px 0 rgba(255,255,255,0.12), 0 12px 18px rgba(0,0,0,0.12);
    }

    #cannonBarrel {
      position: absolute;
      bottom: 40%;
      left: 48%;
      width: 75%;
      height: 34%;
      transform: translateX(-50%) rotate(-10deg);
      transform-origin: left center;
      border-radius: 18px;
      background: #3e5872;
      box-shadow: inset 0 8px 0 rgba(255,255,255,0.12);
    }

    #cannonMouth {
      position: absolute;
      right: -6px;
      top: 18%;
      width: 20%;
      height: 64%;
      border-radius: 999px;
      background: #243647;
      box-shadow: inset 0 6px 0 rgba(255,255,255,0.10);
    }

    #loadedLetter {
      position: absolute;
      left: 50%;
      bottom: 6%;
      transform: translateX(-50%);
      width: clamp(70px, 20vw, 86px);
      height: clamp(40px, 10vw, 48px);
      border-radius: 16px;
      display: grid;
      place-items: center;
      font-weight: 950;
      font-size: clamp(18px, 5vw, 24px);
      color: #0b2a4a;
      background: #ffffff;
      border: 2px dashed rgba(22,50,74,0.25);
      user-select: none;
    }

    /* Toast stays above bottom panel */
    #toast {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(190px + env(safe-area-inset-bottom));
      background: rgba(22,50,74,0.92);
      color: white;
      padding: 10px 14px;
      border-radius: 14px;
      font-weight: 900;
      z-index: 9;
      display: none;
      box-shadow: var(--shadow);
      max-width: 92vw;
      text-align: center;
    }

    /* Projectile */
    .projectile {
      position: absolute;
      width: 56px;
      height: 56px;
      border-radius: 16px;
      display: grid;
      place-items: center;
      font-size: 26px;
      font-weight: 950;
      background: #ffffff;
      border: 3px solid rgba(43,124,255,0.40);
      box-shadow: 0 12px 24px rgba(0,0,0,0.16);
      z-index: 10;
      pointer-events: none;
      user-select: none;
      will-change: transform;
    }

    /* On very small phones, stack buttons to avoid squeezing */
    @media (max-width: 380px) {
      #controlsRow {
        grid-template-columns: 1fr;
        gap: 8px;
        align-items: center;
      }
      #skipBtn, #fireBtn { width: 100%; }
      #cannonWrap { height: 100px; }
      #toast { bottom: calc(220px + env(safe-area-inset-bottom)); }
    }
  </style>
</head>

<body>
  <div id="game">
    <canvas id="fxCanvas"></canvas>

    <div id="topBar">
      <div id="badge">Missing Letter</div>
      <div id="score">Score: <span id="scoreNum">0</span> ‚≠ê</div>
      <div id="hint">Pick the missing letter and tap <b>FIRE</b>.</div>
    </div>

    <div id="wordArea">
      <div id="wordCard">
        <div id="word"></div>
      </div>
    </div>

    <div id="feedback">
      <div class="emoji" id="feedbackEmoji">üò¢</div>
      <div class="text" id="feedbackText">Try again!</div>
    </div>

    <div id="toast"></div>

    <div id="bottomPanel">
      <div id="choicesRow"></div>

      <div id="controlsRow">
        <button id="skipBtn" type="button">New Word</button>

        <div id="cannonWrap">
          <div id="cannon">
            <div id="cannonBarrel">
              <div id="cannonMouth"></div>
            </div>
            <div id="cannonBase"></div>
            <div id="loadedLetter">?</div>
          </div>
        </div>

        <button id="fireBtn" type="button">FIRE üöÄ</button>
      </div>
    </div>
  </div>

  <script>
    // iPhone Safari viewport height fix
    function setVH() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty("--vh", `${vh}px`);
    }
    window.addEventListener("resize", setVH);
    window.addEventListener("orientationchange", setVH);
    setVH();

    // --- Word list ---
    const WORDS = [
      { word: "tiger", type: "animal" }, { word: "zebra", type: "animal" },
      { word: "monkey", type: "animal" }, { word: "elephant", type: "animal" },
      { word: "giraffe", type: "animal" }, { word: "rabbit", type: "animal" },
      { word: "lion", type: "animal" }, { word: "panda", type: "animal" },
      { word: "donkey", type: "animal" },

      { word: "banana", type: "fruit" }, { word: "apple", type: "fruit" },
      { word: "mango", type: "fruit" }, { word: "orange", type: "fruit" },
      { word: "grapes", type: "fruit" }, { word: "papaya", type: "fruit" },
      { word: "cherry", type: "fruit" }, { word: "melon", type: "fruit" },

      { word: "parrot", type: "bird" }, { word: "sparrow", type: "bird" },
      { word: "peacock", type: "bird" }, { word: "pigeon", type: "bird" },
      { word: "eagle", type: "bird" }, { word: "owl", type: "bird" },
      { word: "crow", type: "bird" }
    ];

    // --- Elements ---
    const wordEl = document.getElementById("word");
    const choicesRow = document.getElementById("choicesRow");
    const loadedLetterEl = document.getElementById("loadedLetter");
    const fireBtn = document.getElementById("fireBtn");
    const skipBtn = document.getElementById("skipBtn");
    const toastEl = document.getElementById("toast");
    const scoreNumEl = document.getElementById("scoreNum");
    const feedbackEl = document.getElementById("feedback");
    const feedbackEmojiEl = document.getElementById("feedbackEmoji");
    const feedbackTextEl = document.getElementById("feedbackText");
    const wordCardEl = document.getElementById("wordCard");

    const canvas = document.getElementById("fxCanvas");
    const ctx = canvas.getContext("2d");

    // --- State ---
    let current = null;
    let selectedLetter = null;
    let animating = false;
    let score = 0;

    // --- Helpers ---
    function randInt(min, maxInclusive) {
      return Math.floor(Math.random() * (maxInclusive - min + 1)) + min;
    }
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    function showToast(msg, ms = 1200) {
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => (toastEl.style.display = "none"), ms);
    }

    // Canvas sizing
    function setCanvasSize() {
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(window.innerWidth * dpr);
      canvas.height = Math.floor(window.innerHeight * dpr);
      canvas.style.width = window.innerWidth + "px";
      canvas.style.height = window.innerHeight + "px";
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener("resize", setCanvasSize);
    setCanvasSize();

    function renderWord() {
      wordEl.innerHTML = "";
      const w = current.word.toUpperCase();
      for (let i = 0; i < w.length; i++) {
        const span = document.createElement("span");
        span.className = "letter";
        if (i === current.missingIndex) {
          span.classList.add("blank");
          span.dataset.blank = "1";
          span.textContent = " ";
        } else {
          span.textContent = w[i];
        }
        wordEl.appendChild(span);
      }
    }

    function getBlankElement() {
      return wordEl.querySelector('[data-blank="1"]');
    }

    function generateChoices(correctChar) {
      const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
      const options = new Set([correctChar]);
      const total = (current.word.length <= 5) ? 3 : 4;
      while (options.size < total) {
        options.add(alphabet[randInt(0, alphabet.length - 1)]);
      }
      return shuffle([...options]);
    }

    function clearSelectionUI() {
      selectedLetter = null;
      loadedLetterEl.textContent = "?";
      document.querySelectorAll(".choiceBtn").forEach(b => b.classList.remove("selected"));
    }

    function newRound() {
      animating = false;
      fireBtn.disabled = false;
      hideFeedback();
      clearSelectionUI();

      const pick = WORDS[randInt(0, WORDS.length - 1)];
      const word = pick.word.trim().toLowerCase();

      const minIndex = word.length >= 4 ? 1 : 0;
      const maxIndex = word.length - 2 >= minIndex ? word.length - 2 : word.length - 1;
      const missingIndex = randInt(minIndex, maxIndex);

      current = {
        word,
        type: pick.type,
        missingIndex,
        missingChar: word[missingIndex].toUpperCase()
      };

      renderWord();

      const choices = generateChoices(current.missingChar);
      choicesRow.innerHTML = "";
      choices.forEach(ch => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "choiceBtn";
        btn.textContent = ch;
        btn.addEventListener("click", () => {
          if (animating) return;
          selectedLetter = ch;
          loadedLetterEl.textContent = ch;
          document.querySelectorAll(".choiceBtn").forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
        });
        choicesRow.appendChild(btn);
      });
    }

    function getCannonMouthCenter() {
      const mouth = document.getElementById("cannonMouth");
      const r = mouth.getBoundingClientRect();
      return { x: r.left + r.width / 2, y: r.top + r.height / 2 };
    }

    function getBlankCenter() {
      const blank = getBlankElement();
      const r = blank.getBoundingClientRect();
      return { x: r.left + r.width / 2, y: r.top + r.height / 2 };
    }

    function animateShot(letter, onDone) {
      const start = getCannonMouthCenter();
      const end = getBlankCenter();

      const proj = document.createElement("div");
      proj.className = "projectile";
      proj.textContent = letter;
      proj.style.left = (start.x - 28) + "px";
      proj.style.top  = (start.y - 28) + "px";
      proj.style.transform = "translate(0px, 0px) scale(1)";

      document.body.appendChild(proj);

      const dx = (end.x - start.x);
      const dy = (end.y - start.y);

      requestAnimationFrame(() => {
        proj.style.transition = "transform 520ms cubic-bezier(0.2, 0.9, 0.2, 1.0)";
        proj.style.transform = `translate(${dx}px, ${dy}px) scale(0.92)`;
      });

      proj.addEventListener("transitionend", () => {
        proj.remove();
        onDone?.();
      }, { once: true });
    }

    function showFeedback(ok) {
      feedbackEl.style.display = "block";
      if (ok) {
        feedbackEmojiEl.textContent = "üéâ";
        feedbackTextEl.textContent = "Correct!";
      } else {
        feedbackEmojiEl.textContent = "üò¢";
        feedbackTextEl.textContent = "Try again!";
      }
    }
    function hideFeedback() { feedbackEl.style.display = "none"; }

    // Fireworks
    let particles = [];
    let fxRunning = false;

    function launchFireworks(x, y) {
      const count = 90;
      for (let i = 0; i < count; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = 2 + Math.random() * 4.5;
        particles.push({
          x, y,
          vx: Math.cos(angle) * speed,
          vy: Math.sin(angle) * speed,
          life: 50 + Math.random() * 30,
          size: 2 + Math.random() * 2.5,
          r: randInt(80, 255),
          g: randInt(80, 255),
          b: randInt(80, 255),
        });
      }
      if (!fxRunning) {
        fxRunning = true;
        requestAnimationFrame(fxLoop);
      }
    }

    function fxLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      for (const p of particles) {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.06;
        p.vx *= 0.99;
        p.vy *= 0.99;
        p.life -= 1;

        const alpha = Math.max(0, p.life / 80);
        ctx.globalAlpha = alpha;
        ctx.fillStyle = `rgb(${p.r},${p.g},${p.b})`;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();
      }
      ctx.restore();

      particles = particles.filter(p => p.life > 0);
      if (particles.length > 0) requestAnimationFrame(fxLoop);
      else {
        fxRunning = false;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    }

    function fire() {
      if (animating) return;

      if (!selectedLetter) {
        showToast("Select a letter first üôÇ");
        return;
      }

      animating = true;
      fireBtn.disabled = true;
      hideFeedback();

      animateShot(selectedLetter, () => {
        const ok = (selectedLetter === current.missingChar);

        if (ok) {
          const blank = getBlankElement();
          blank.classList.add("filled");
          blank.textContent = current.missingChar;

          showFeedback(true);

          const c = getBlankCenter();
          launchFireworks(c.x, c.y);

          score += 1;
          scoreNumEl.textContent = String(score);

          setTimeout(() => newRound(), 1100);
        } else {
          showFeedback(false);
          wordCardEl.classList.remove("shake");
          void wordCardEl.offsetWidth;
          wordCardEl.classList.add("shake");

          setTimeout(() => {
            fireBtn.disabled = false;
            animating = false;
          }, 350);
        }
      });
    }

    fireBtn.addEventListener("click", fire);
    skipBtn.addEventListener("click", () => { if (!animating) newRound(); });

    newRound();
  </script>
</body>
</html>
